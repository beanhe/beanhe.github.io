---
layout: post
title: Ubuntu 14.04安装kubernetes 1.6集群
category: ubuntu,虚拟化,docker,kubernetes
tags: [__beanhe,ubuntu,虚拟化,docker,kubernetes]
---

#### 准备
  - 需要有可以绕过GFW的代理或者能够通过其他方式获取到`gcr.io`中的镜像，否则：不要挣扎，放弃吧
  - 有自己的Docker Private Registry存放从墙外拿到的镜像
  - 两台以上ubuntu 14.04 server，本示例中一台master,两台node，server角色如下：
  
 
 | 角色  | IP  |
| :------------: | :------------: |
| master  |  10.19.35.143 |
|  node1（kube-minion1） |  10.19.35.144 |
| node2（kube-minion2）  | 10.19.35.145  |
| 自建docker registry  | https://hub.kubiops.com |



#### 软件版本


| 软件  | 版本 |  下载地址 |
| :------------: | :------------: | :------------: |
| OS | Ubuntu14.04  | [官方地址](http://releases.ubuntu.com/14.04/ubuntu-14.04.5-server-amd64.iso) |
| docker  | docker-ce 17.03.1-ce  |apt安装，参考：[链接](https://docs.docker.com/engine/installation/linux/ubuntu/#install-using-the-repository) |
| kubernetes  | release-1.4.0 | [二进制文件下载地址](https://storage.googleapis.com/kubernetes-release/release/v1.4.0/kubernetes-server-linux-amd64.tar.gz) |
| etcd  |  2.3.1 |[github下载地址](https://github.com/coreos/etcd/releases/download/v2.3.1/etcd-v2.3.1-linux-amd64.tar.gz)  |
| flannel  |  0.5.5 |[github下载地址](https://github.com/coreos/flannel/releases/download/v0.5.5/flannel-0.5.5-linux-amd64.tar.gz)  |



#### 步骤
- 【注】步骤标题前面`【A】`表示此步骤所有机器都需要按要求执行, `【M】`表示此步骤只有master才需要执行，`【N】`表示此步骤只有node才需要执行

- 【A】所有机器安装`docker-ce`，参考[官方教程](https://docs.docker.com/engine/installation/linux/ubuntu/#install-using-the-repository)，或者按以下步骤操作：

```
apt-get install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
apt-get update
apt-get install -y docker-ce bridge-utils
```

- 【A】关闭防火墙；创建二进制文件目录`/opt/bin`

```
# 【A】关闭防火墙
ufw disable
# 如果确定iptables没有有用的rule也可以清除一下iptables规则
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT


# 【A】创建bin目录
mkdir /opt/bin
```

- 【A】在所有机器创建有`sudo`权限的用户，使用`ssh-keygen -t rsa`在master上生成SSH密钥对并保证master可以通过ssh密钥访问控制所有节点，此处为了方便直接使用`root`用户:


```

# 【M】master上生成SSH密钥对
ssh-keygen -t rsa

# 【M】将上述命令生成的 `id_rsa.pub`公钥ssh-copy到所有节点，保证存在控制用户的`~/.ssh/authorized_keys`文件中
ssh-copy-id -i ~/.ssh/id_rsa.pub 10.19.35.144
ssh-copy-id -i ~/.ssh/id_rsa.pub 10.19.35.145
```

- 【M】master配置环境变量

```
export KUBE_VERSION=1.4.0
export FLANNEL_VERSION=0.5.5
export ETCD_VERSION=2.3.1
export KUBERNETES_PROVIDER=ubuntu
```

- 【M】从github clone代码，修改配置文件，将`config-default.conf`中的nodes变量更改为你环境中的用户名和密码，其他变量可以自己根据自己环境定义，主要是保证其中的子网不要跟物理环境冲突即可，然后开始部署

```
git clone -b release-1.4.0 https://github.com/kubernetes/kubernetes.git
cd kubernetes/cluster
# 修改配置
sed -i 's/export nodes=${nodes:-"vcap@10.10.103.250 vcap@10.10.103.162 vcap@10.10.103.223"}/export nodes=${nodes:-"root@10.19.35.143 root@10.19.35.144 root@10.19.35.145"}/' ubuntu/config-default.sh

# 开始部署
./kube-up.sh
```

- 上面的部署会从`github`中下载数据库，很耗时，所以大家可以参考`kubernetes/cluster/ubuntu/download-release.sh`脚本中的下载链接，手动下载后在执行`kube-up.sh`命令，部署成功后会有提示`Cluster validation succeeded`

- 部署完成后可以会发现`/opt/bin`目录中没有`kubectl`程序，可以从`kubernetes/cluster/ubuntu/binaries`中copy到`/opt/bin`或者其他系统PATH `bin`目录中即可，成功可以查看一下所有节点是否都正常工作，正常状态如下：

```
root@kube1:~/kubernetes/cluster# kubectl get nodes
NAME           STATUS    AGE
10.19.35.143   Ready     45m
10.19.35.144   Ready     44m
10.19.35.145   Ready     44m
```

- 到这里基本完成，添加自己的私有`docker registry`可以使用如下命令：

```
kubectl create secret docker-registry regsecret --docker-server=hub.kubiops.com --docker-username=docker --docker-password=kubiops --docker-email=admin@kubiops.com

# 命令中regsecret为registry的唯一标识，可以在配置文件中用来定义imagePullSecrets，见下面的示例。--docker-server用来指定私有docker registry,可以是域名也可以是<IP>:<PORT>的形式，--docker-username用来指定访问用户名，--docker-password指定访问密码，--docker-email指定email
```

- 下面通过一个示例来展示和解决无法创建pod的问题，比如有如下创建pod的配置文件，通过这个文件来创建pod看看结果

```
root@kube1:/usr/local/src# cat redis-master-controller.yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: redis-master
  labels:
    name: redis-master
spec:
  replicas: 1
  selector:
    name: redis-master
  template:
    metadata:
      labels:
        name: redis-master
    spec:
      containers:
        - name: redis-master
          image: hub.kubiops.com/kubeguide/redis-master
          ports:
            - containerPort: 6379
      imagePullSecrets:
        - name: regsecret
root@kube1:/usr/local/src# kubectl create -f redis-master-controller.yaml
replicationcontroller "redis-master" created
root@kube1:/usr/local/src# kubectl get pods -o wide
NAME                 READY     STATUS              RESTARTS   AGE       IP        NODE
redis-master-vvfhp   0/1       ContainerCreating   0          15s       <none>    10.19.35.144
```

- 会发现pod一直处于`ContainerCreating`状态，此时通过`kubectl descibe pod`命令来查看`pod`创建详情

```
root@kube1:/usr/local/src# kubectl describe pod redis-master-vvfhp
Name:		redis-master-vvfhp
Namespace:	default
Node:		10.19.35.144/10.19.35.144
Start Time:	Fri, 19 May 2017 10:40:02 +0000
Labels:		name=redis-master
Status:		Pending
IP:
Controllers:	ReplicationController/redis-master
Containers:
  redis-master:
    Container ID:
    Image:		hub.kubiops.com/kubeguide/redis-master
    Image ID:
    Port:		6379/TCP
    State:		Waiting
      Reason:		ContainerCreating
    Ready:		False
    Restart Count:	0
    Volume Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5pj5a (ro)
    Environment Variables:	<none>
Conditions:
  Type		Status
  Initialized 	True
  Ready 	False
  PodScheduled 	True
Volumes:
  default-token-5pj5a:
    Type:	Secret (a volume populated by a Secret)
    SecretName:	default-token-5pj5a
QoS Class:	BestEffort
Tolerations:	<none>
Events:
  FirstSeen	LastSeen	Count	From			SubobjectPath	Type		Reason		Message
  ---------	--------	-----	----			-------------	--------	------		-------
  1m		1m		1	{default-scheduler }			Normal		Scheduled	Successfully assigned redis-master-vvfhp to 10.19.35.144
  42s		42s		1	{kubelet 10.19.35.144}			Warning		FailedSync	Error syncing pod, skipping: failed to "StartContainer" for "POD" with ErrImagePull: "image pull failed for gcr.io/google_containers/pause-amd64:3.0, this may be because there are no credentials on this request.  details: (Error response from daemon: {\"message\":\"Get https://gcr.io/v1/_ping: dial tcp 74.125.204.82:443: i/o timeout\"})"
```

- 【A】通过结果可以看出是因为无法从`gcr.io`获取`StartContainer`: `gcr.io/google_containers/pause-amd64:3.0`，明显被GFW和谐了，为了解决这个问题，可以通过能够科学上网的服务器或者代理实现`docker pull gcr.io/google_containers/pause-amd64:3.0`然后通过`docker save`将镜像保存为`tarball`并上传至自己的私有dokcer registry，然后通过自己的registry领取这个镜像并更名为所需名称，即可解决上述故障，以下命令从从本地拉取已有镜像开始：


```
root@kube:~# docker pull hub.kubiops.com/gcr.io/google_containers/pause-amd64:3.0
3.0: Pulling from gcr.io/google_containers/pause-amd64
a3ed95caeb02: Pull complete
d7968197c95c: Pull complete
Digest: sha256:7b23a11e164b0cfa08188d9f976da9f890464cdeb81c1f7c8ef008f03df3681e
Status: Downloaded newer image for hub.kubiops.com/gcr.io/google_containers/pause-amd64:3.0
root@kube:~# docker tag 99e59f495ffa gcr.io/google_containers/pause-amd64:3.0
root@kube:~# docker rmi hub.kubiops.com/gcr.io/google_containers/pause-amd64:3.0
Untagged: hub.kubiops.com/gcr.io/google_containers/pause-amd64:3.0
Untagged: hub.kubiops.com/gcr.io/google_containers/pause-amd64@sha256:7b23a11e164b0cfa08188d9f976da9f890464cdeb81c1f7c8ef008f03df3681e
root@kube2:~# docker images
REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE
gcr.io/google_containers/pause-amd64   3.0                 99e59f495ffa        12 months ago       747 kB
```

- 【M】然后返回master发现问题解决，pod正常创建，对应节点也启动了对应的docker container

```
root@kube1:/usr/local/src# kubectl describe pod redis-master-vvfhp
Name:		redis-master-vvfhp
Namespace:	default
Node:		10.19.35.144/10.19.35.144
Start Time:	Fri, 19 May 2017 10:40:02 +0000
Labels:		name=redis-master
Status:		Running
IP:		172.16.70.2
Controllers:	ReplicationController/redis-master
Containers:
  redis-master:
    Container ID:	docker://ff952b7af09c806b8dd55b1004538176a5d63879bfdb445cf8490b4b1a49617b
    Image:		hub.kubiops.com/kubeguide/redis-master
    Image ID:		docker://sha256:405a0b586f7ebeb545ec65be0e914311159d1baedccd3a93e9d3e3b249ec5cbd
    Port:		6379/TCP
    State:		Running
      Started:		Fri, 19 May 2017 10:47:10 +0000
    Ready:		True
    Restart Count:	0
    Volume Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5pj5a (ro)
    Environment Variables:	<none>
Conditions:
  Type		Status
  Initialized 	True
  Ready 	True
  PodScheduled 	True
Volumes:
  default-token-5pj5a:
    Type:	Secret (a volume populated by a Secret)
    SecretName:	default-token-5pj5a
QoS Class:	BestEffort
Tolerations:	<none>
Events:
  FirstSeen	LastSeen	Count	From			SubobjectPath	Type		Reason		Message
  ---------	--------	-----	----			-------------	--------	------		-------
  7m		7m		1	{default-scheduler }			Normal		Scheduled	Successfully assigned redis-master-vvfhp to 10.19.35.144
  5m		2m		10	{kubelet 10.19.35.144}			Warning		FailedSync	Error syncing pod, skipping: failed to "StartContainer" for "POD" with ImagePullBackOff: "Back-off pulling image \"gcr.io/google_containers/pause-amd64:3.0\""

  7m	1m	5	{kubelet 10.19.35.144}		Warning	FailedSync	Error syncing pod, skipping: failed to "StartContainer" for "POD" with ErrImagePull: "image pull failed for gcr.io/google_containers/pause-amd64:3.0, this may be because there are no credentials on this request.  details: (Error response from daemon: {\"message\":\"Get https://gcr.io/v1/_ping: dial tcp 74.125.204.82:443: i/o timeout\"})"

  55s	55s	1	{kubelet 10.19.35.144}	spec.containers{redis-master}	Normal	Pulling	pulling image "hub.kubiops.com/kubeguide/redis-master"
  40s	40s	1	{kubelet 10.19.35.144}	spec.containers{redis-master}	Normal	Pulled	Successfully pulled image "hub.kubiops.com/kubeguide/redis-master"
  40s	40s	1	{kubelet 10.19.35.144}	spec.containers{redis-master}	Normal	Created	Created container with docker id ff952b7af09c; Security:[seccomp=unconfined]
  40s	40s	1	{kubelet 10.19.35.144}	spec.containers{redis-master}	Normal	Started	Started container with docker id ff952b7af09c
```


- 至此，整个kubernetes全部搭建完成（好多坑啊），觉得有帮助可以扫码打赏，鼓励一下咯

- 文中很多软件如果有需要，可通过binaryhe@aliyun.com有偿获取
- 文章原创，转载注明，谢谢合作



 | 支付宝  | 微信  |
| :------------: | :------------: |
|![扫我扫我](http://www.kubiops.com/files/201705/17193422709_IMG_6808.jpg "扫我扫我")|![扫我扫我](http://www.kubiops.com/files/201705/17193440552_IMG_6809.jpg "扫我扫我")|
---
layout: post
title: LVM笔记
category: lvm
tags: [__beanhe,lvm]
---

### LVM Notes
- Disk partitioning with `fdisk`. 

	```
	> fdisk /dev/sdb
	n					# New partition
	p					# Partition type(p -> primary, e -> extended)
	1					# Partition number
	<Enter>			  # Partition start position
	<Enter>			  # Partition end position
	t					# Change partition system id
	<Enter>			 # Speicify partition number
	8e				  # Specify partition system id to 8e(Linux LVM)
	w				  # Write partition table
	> partprobe   # Inform the OS of the partition table changes
	```

- Create LVM

	```
	# Create Physical Volume
	[root@CNWS002 ~]# pvcreate /dev/sdb1
	  Physical volume "/dev/sdb1" successfully created.
	[root@CNWS002 ~]# pvs
	  PV         VG Fmt  Attr PSize   PFree
	  /dev/sdb1     lvm2 ---  <40.00g <40.00g
	[root@CNWS002 ~]# pvdisplay
	  "/dev/sdb1" is a new physical volume of "<40.00 GiB"
	  --- NEW Physical volume ---
	  PV Name               /dev/sdb1
	  VG Name
	  PV Size               <40.00 GiB
	  Allocatable           NO
	  PE Size               0
	  Total PE              0
	  Free PE               0
	  Allocated PE          0
	  PV UUID               CXzUA4-h0jJ-2n9l-gaXI-oVIp-Qm1s-TpEzQ9
	# Create Volume Group
	[root@CNWS002 ~]# vgcreate vg_grp01 /dev/sdb1
	  Volume group "vg_grp01" successfully created
	[root@CNWS002 ~]# vgs
	  VG       #PV #LV #SN Attr   VSize   VFree
	  vg_grp01   1   0   0 wz--n- <40.00g <40.00g
	[root@CNWS002 ~]# vgdisplay
	  --- Volume group ---
	  VG Name               vg_grp01
	  System ID
	  Format                lvm2
	  Metadata Areas        1
	  Metadata Sequence No  1
	  VG Access             read/write
	  VG Status             resizable
	  MAX LV                0
	  Cur LV                0
	  Open LV               0
	  Max PV                0
	  Cur PV                1
	  Act PV                1
	  VG Size               <40.00 GiB
	  PE Size               4.00 MiB
	  Total PE              10239
	  Alloc PE / Size       0 / 0
	  Free  PE / Size       10239 / <40.00 GiB
	  VG UUID               dBXKTM-8RX9-JwlV-A4SC-AJfN-hcYj-yjlUEk
	# Create Logical Volume
	[root@CNWS002 ~]# lvcreate -L 30G -n lv_01 vg_grp01
	  Wiping xfs signature on /dev/vg_grp01/lv_01.
	  Logical volume "lv_01" created.
	  [root@CNWS002 ~]# lvs
	  LV    VG       Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
	  lv_01 vg_grp01 -wi-a----- 30.00g
	[root@CNWS002 ~]# lvdisplay
	  --- Logical volume ---
	  LV Path                /dev/vg_grp01/lv_01
	  LV Name                lv_01
	  VG Name                vg_grp01
	  LV UUID                k9KXFz-cBw9-yFis-V3sJ-dps1-wEiO-jvJRo8
	  LV Write Access        read/write
	  LV Creation host, time CNWS002, 2019-05-07 16:55:30 +0800
	  LV Status              available
	  # open                 0
	  LV Size                30.00 GiB
	  Current LE             7680
	  Segments               1
	  Allocation             inherit
	  Read ahead sectors     auto
	  - currently set to     8192
	  Block device           253:0
	  # Format LVM to xfs
	[root@CNWS002 ~]# mkfs.xfs /dev/vg_grp01/lv_01
	meta-data=/dev/vg_grp01/lv_01    isize=512    agcount=4, agsize=1966080 blks
			    =                       sectsz=512   attr=2, projid32bit=1
			    =                       crc=1        finobt=0, sparse=0
	data      =                       bsize=4096   blocks=7864320, imaxpct=25
			    =                       sunit=0      swidth=0 blks
	naming  =version 2              bsize=4096   ascii-ci=0 ftype=1
	log        =internal log           bsize=4096   blocks=3840, version=2
			    =                       sectsz=512   sunit=0 blks, lazy-count=1
	realtime =none                   extsz=4096   blocks=0, rtextents=0
	
	# Mount LVM
	[root@CNWS002 ~]# mkdir -p /disk/test/
	[root@CNWS002 ~]# mount /dev/vg_grp01/lv_01 /disk/test/
	[root@CNWS002 ~]# df -hT
	Filesystem                 Type      Size  Used Avail Use% Mounted on
	/dev/sdd1                  xfs       9.4G  802M  8.6G   9% /
	devtmpfs                   devtmpfs  900M     0  900M   0% /dev
	tmpfs                      tmpfs     910M     0  910M   0% /dev/shm
	tmpfs                      tmpfs     910M  9.5M  901M   2% /run
	tmpfs                      tmpfs     910M     0  910M   0% /sys/fs/cgroup
	/dev/sdf1                  xfs        20G  1.9G   19G  10% /usr
	/dev/sde1                  xfs        80G   20G   61G  25% /home
	/dev/sdg1                  xfs        20G  617M   20G   4% /var
	/dev/sda1                  xfs       378M  198M  180M  53% /boot
	tmpfs                      tmpfs     182M     0  182M   0% /run/user/0
	/dev/mapper/vg_grp01-lv_01 xfs        30G   33M   30G   1% /disk/test
	```
	
- Extend LVM
	- If Volume Group still have free size, just extend LV via `lvextend`
	
	```
	[root@CNWS002 ~]# vgdisplay
 	 --- Volume group ---
	  VG Name               vg_grp01
	  System ID
	  Format                lvm2
	  Metadata Areas        1
	  Metadata Sequence No  2
	  VG Access             read/write
	  VG Status             resizable
	  MAX LV                0
	  Cur LV                1
	  Open LV               1
	  Max PV                0
	  Cur PV                1
	  Act PV                1
	  VG Size               <40.00 GiB
	  PE Size               4.00 MiB
	  Total PE              10239
	  Alloc PE / Size       7680 / 30.00 GiB
	  Free  PE / Size       2559 / <10.00 GiB						# From this line we can find there are still nearly 10G could be used
	  VG UUID               dBXKTM-8RX9-JwlV-A4SC-AJfN-hcYj-yjlUEk
	  
	  # Extend LV
	[root@CNWS002 ~]# lvextend -L +2G /dev/mapper/vg_grp01-lv_01
	  Size of logical volume vg_grp01/lv_01 changed from 30.00 GiB (7680 extents) to 32.00 GiB (8192 extents).
	  Logical volume vg_grp01/lv_01 successfully resized.
	[root@CNWS002 ~]# df -h
	Filesystem                  Size  Used Avail Use% Mounted on
	/dev/sdd1                   9.4G  802M  8.6G   9% /
	devtmpfs                    900M     0  900M   0% /dev
	tmpfs                       910M     0  910M   0% /dev/shm
	tmpfs                       910M  9.5M  901M   2% /run
	tmpfs                       910M     0  910M   0% /sys/fs/cgroup
	/dev/sdf1                    20G  1.9G   19G  10% /usr
	/dev/sde1                    80G   20G   61G  25% /home
	/dev/sdg1                    20G  617M   20G   4% /var
	/dev/sda1                   378M  198M  180M  53% /boot
	tmpfs                       182M     0  182M   0% /run/user/0
	/dev/mapper/vg_grp01-lv_01   30G   33M   30G   1% /disk/test
	```
	
		- we extend the LV size from 30G to 32G now, but still found the total size in `df` ouputs is 30G. To take effect, there is still filesystem resize action needed. `resize2fs` is used for `ext2/ext3/ext4`. `xfs_growfs` is used for XFS. In our example, `xfs_growfs` is needed.
		
		```
		[root@CNWS002 ~]# xfs_growfs /dev/mapper/vg_grp01-lv_01
		meta-data=/dev/mapper/vg_grp01-lv_01 isize=512    agcount=4, agsize=1966080 blks
				 =                       sectsz=512   attr=2, projid32bit=1
				 =                       crc=1        finobt=0 spinodes=0
		data     =                       bsize=4096   blocks=7864320, imaxpct=25
				 =                       sunit=0      swidth=0 blks
		naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
		log      =internal               bsize=4096   blocks=3840, version=2
				 =                       sectsz=512   sunit=0 blks, lazy-count=1
		realtime =none                   extsz=4096   blocks=0, rtextents=0
		data blocks changed from 7864320 to 8388608
		[root@CNWS002 ~]# df -hT
		Filesystem                 Type      Size  Used Avail Use% Mounted on
		/dev/sdd1                  xfs       9.4G  802M  8.6G   9% /
		devtmpfs                   devtmpfs  900M     0  900M   0% /dev
		tmpfs                      tmpfs     910M     0  910M   0% /dev/shm
		tmpfs                      tmpfs     910M  9.5M  901M   2% /run
		tmpfs                      tmpfs     910M     0  910M   0% /sys/fs/cgroup
		/dev/sdf1                  xfs        20G  1.9G   19G  10% /usr
		/dev/sde1                  xfs        80G   20G   61G  25% /home
		/dev/sdg1                  xfs        20G  617M   20G   4% /var
		/dev/sda1                  xfs       378M  198M  180M  53% /boot
		tmpfs                      tmpfs     182M     0  182M   0% /run/user/0
		/dev/mapper/vg_grp01-lv_01 xfs        32G   33M   32G   1% /disk/test
		```
	
	- If Volume Group space is used up, new PV is needed for expanding the VG, finally LV could be expanded.
	
	```
	[root@CNWS002 ~]# pvcreate /dev/sdb2
	  Physical volume "/dev/sdb2" successfully created.
	[root@CNWS002 ~]# vgextend vg_grp01 /dev/sdb2
	  Volume group "vg_grp01" successfully extended
	[root@CNWS002 ~]# vgdisplay
	  --- Volume group ---
	  VG Name               vg_grp01
	  System ID
	  Format                lvm2
	  Metadata Areas        2
	  Metadata Sequence No  4
	  VG Access             read/write
	  VG Status             resizable
	  MAX LV                0
	  Cur LV                1
	  Open LV               1
	  Max PV                0
	  Cur PV                2
	  Act PV                2
	  VG Size               44.99 GiB
	  PE Size               4.00 MiB
	  Total PE              11518
	  Alloc PE / Size       8192 / 32.00 GiB
	  Free  PE / Size       3326 / 12.99 GiB				# VG is expanded
	  VG UUID               dBXKTM-8RX9-JwlV-A4SC-AJfN-hcYj-yjlUEk
	```
	
	- After steps above, just do the same steps to expand the LV.
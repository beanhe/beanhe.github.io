---
layout: post
title: mysql相关配置
category: mysql
tags: [mysql,my.cnf]
---

- mysql主配置文件相关配置及含义
	- [mysqld] log: 用来指定记录SQL语句执行日志的文件路径，配置后可以在指定的文件中看到SQL语句的执行日志，格式如下：

	```
[04:38:52 PM]root@devops: ~ # tailf /var/lib/mysql/sql_row.log
150923 16:35:04	   14 Quit
150923 16:35:05	   15 Connect	root@192.168.0.238 on
                   15 Query	SET NAMES utf8
                   15 Query	USE `wind`
                   15 Query	select * from `wind`.`MACROPOSITIVENEWS`  limit 0,1000
150923 16:35:07	   15 Query	show columns from `wind`.`MACROPOSITIVENEWS`
                   15 Query	show index from `wind`.`MACROPOSITIVENEWS`
                   15 Query	show create table `wind`.`MACROPOSITIVENEWS`
150923 16:35:12	   15 Quit
	```
	上面日志中，以空格分隔，从左往右字段含义为：SQL执行年月日/SQL执行时分秒/SQL语句组编号/SQL执行动作/SQL指令

	- [mysqld] log_slow_queries和long_query_time：
		- log_slow_queries：用来指定记录慢速查询日志的文件路径
		- long_query_time：用来定义语句执行超过多久才算慢速查询，单位为妙
		- 日志格式如下：
		
		```
		[04:48:19 PM]root@devops: ~ # cat /var/lib/mysql/mysql-slow.log
		Time                 Id Command    Argument
		# Time: 150923 16:34:20
		# User@Host: root[root] @  [192.168.0.238]
		# Query_time: 1.416735  Lock_time: 0.073116 Rows_sent: 1000  Rows_examined: 1000
		use wind;
		SET timestamp=1442997260;
		select * from `wind`.`HOTTOPICNEWS`  limit 0,1000;
		```
	- [mysqld] port: 指定MySQL监听端口
	- [mysqld] socket: 指定MySQL的socket文件路径
	- [mysqld] pid-file: 指定MySQL的pid文件路径
	- [mysqld] log-error: 指定MySQL运行日志文件路径（注意与log的区别）
	- [mysqld] interactive_timeout: 指定服务器关闭交互式连接前等待活动的时间（单位：秒），默认为28800s，即8小时
	- [mysqld] wait_timeout: 指定服务器关闭非交互式连接前等待活动的时间（单位：秒），默认为28800s，即8小时
		- `wait_timeout`和`interactive_timeout`一般配合使用，单独使用无效，当通过`show processlist`查看发现有大量SLEEP连接时，这些连接就处于空闲状态，白白占用系统开销，此时可以通过降低这两个超时时间来控制，但不能设置过小，否则可能导致`ERROR 2006 (HY000): MySQL server has gone away`的报错
	- [mysqld] max_connections: 定义并发连接数的上限，当并发连接数达到这个值时，新的连接就会被放到堆栈中排队（队列长度由下面的back_log决定），`max_connection`值的设置可以通过参考`show status 'Max_used_connections'`的值来确定，保持`Max_used_connections/max_connections`不超过85%左右即可，当然设置的前提是要参考服务器的硬件配置
		- 默认值：5.1.14之前（包含）的版本为100，之后版本为151；最大值：5.1.16之前（包含）的版本为16384，之后版本为100000；最小值：1
	- [mysqld] back_log: 定义MySQL的TCP/IP队列的最大值：如上面`max_connection`提到的，当MySQL的连接数达到max_connections时，新来的请求就会被放到堆栈中排队等待其他连接释放资源，而`back_log`指的就是这个堆栈中队列的上限，若新连接再超过这个上限值，则会被MySQL服务器拒绝掉，出现`ERROR 1040 (HY000): Too many connections`的报错提醒。
		- 默认值：151，最大值：65535，最小值：1
	- [msyqld] skip-networking：不在TCP/IP端口进行监听，如果所有要与MySQL通信的服务都在本机，则这种设置最安全，此时所有MySQL连接都是通过Unix Sockets或者命名管道进行的，但生产环境中，一般不会把其他服务与数据库放在一起，所以这个配置要注释掉，否则会导致所有其他机器无法与MySQL连接通信
		- 【注】`back_log`不能超过系统TCP/IP连接队列上限的大小，否则无效，查看系统当前TCP/IP队列上限命令为`cat /proc/sys/net/ipv4/tcp_max_syn_backlog`或者`sysctl -a | grep tcp_max_syn_backlog`，修改方法为`sysctl -w tcp_max_syn_backlog=8192`或者直接修改`/etc/sysctl.conf`中的`tcp_max_syn_backlog`再`sysctl -p`使其生效，`sysctl -w`修改方法是临时的，重启会失效
	- [mysqld] max_connect_errors：客户端连接最大的错误允许量，若达到此限制，则此客户端会被MySQL阻止出现`Host 'host_name' is blocked because of many connection errors.\n Unblock with 'mysqladmin flush-hosts'`报错（有待考察，博主故意出错N此早达到错误上限，但仍然可以正常连接），直到执行了`FLUSH HOSTS`或`mysqladmin flush-hosts`或者重启才能解除限制
		- 最小值：1；最大值：32位平台为4294967295，64位平台为18446744073709547520；默认值：10
	- [mysqld] table_open_cache：5.1.3之前（不包括）叫`table_cache`，代表所有线程能够打开的数据表的最大值，增加此值就代表增加mysqld所需要的文件描述符的数量(所以与ulimit和sysctl有关)。每当MySQL访问一个表时，如果在表缓冲区还有空间，则该表就被打开放入其中，这样可以更快的访问表的内容。通过检查峰值时间的状态值`Open_tables（当前缓存中打开的表的数量，flush tables会使系统关闭一些当前未使用的表而减小此值）`和`Opened_tables（当前已经打开的表的数量，不受flush tables影响）`如果发现`Open_tables`等于`table_open_cache`并且`Opened_tables`还在增长，就需要增加`table_open_cache`的值了，可通过`show status like "Open%tables"`查看上述状态值。
		- 默认值：随着机器内存增大默认值也会相应增大，一般4G内存默认为2048，8G内存为4096。
	- [mysqld] open_files_limit：mysqld能够打开的最大文件描述符数，不能超过系统对文件描述符的限制，否则无效，经过验证，不同版本的mysql产生的效果不同
	- [mysqld] max_allowed_packet：mysql能处理的请求包的最大大小以及服务所能处理的最大请求大小，每个连接独立的大小。当与大的BLOB字段一起工作时很必要
	- [mysqld] binlog_cache_size（单位：字节）：binlog用来记录在一个事务中SQL语句所持有的cache大小。如果经常使用较大且多语句的事务，可以考虑通过增加此值来提高性能。此变量作用域为session
		- 默认值：32768；最小值：4096；最大值：32位系统为4294967295，64位系统为18446744073709547520
		- 在`show status`中有`binlog_cache_use`和`binlog_cache_disk_use`两个值，这两个值可以帮助决定如何设置`binlog_cache_size`的大小，通常情况，如果事务执行存储SQL语句的内存大小不超过`binlog_cache_size`值则正常使用cache,否则会将超出的uncommitted部分记录在临时文件中，很明显后者性能不如前者，在这个过程中，`binlog_cache_use`就代表正常使用`binlog_cache`的事务执行数量，`binlog_cache_disk_use`就代表使用过临时文件的情况的数量。因此当发现`binlog_cache_disk_use`较大时，可考虑提升`binlog_cache_size`的值以提升性能
	- [mysqld] max_binlog_cache_size：定义二进制日志缓存区大小的上限，若处理多语句事务时需要的内存大小比此值大，则会出现`error: Multi-statement transaction required more than 'max_binlog_cache_size' bytes of storage`的报错提醒。此变量作用域为global，默认值几乎相当于无穷大`18446744073709547520`，一般不用修改`` 

---
layout: post
title: 使用groovy脚本初始化系统权限
category: jenkins
tags: [__beanhe,jenkins,ci,自动化,集成开发]
---

### 使用groovy脚本初始化Jenkins用户权限

##### Jenkins权限
- `Jenkins`默认使用自己的数据库来进行权限区分，常见权限控制有如下图方框的几种方式

![](/files/201707/24104936297_WX20170724-104636.png)

##### 使用groovy脚本实现权限自动初始化

- `Jenkins`支持使用`goovy`进行内部`API`的调用以实现自动化的操作，以下以两种不同的方式为例记录一下如何使用`groovy`脚本实现权限的初始化

- 在`$JENKINS_HOME/init.groovy.d`目录下创建`init.user.groovy`脚本，内容如下

```
#!groovy

import jenkins.model.*
import hudson.security.*

def user = System.getenv('admin')
def password = System.getenv('password')

def instance = Jenkins.getInstance()

println "--> creating local user"

def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount(user,password)
instance.setSecurityRealm(hudsonRealm)

def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
instance.setAuthorizationStrategy(strategy)
instance.save()
```

- 这个脚本的作用如图，同时会创建一个用户名为`admin`密码为`password`的用户
![](/files/201707/24112624577_2.png)

- 如果使用`安全矩阵`的方式，可以参考[这个脚本](https://gist.github.com/jnbnyc/c6213d3d12c8f848a385)，脚本中`//`开头为注释行，由于`Jenkins.ADMINISTER`代表了管理员的权限，所以细化的权限被注释了，脚本中`anonymous `代表匿名用户。此脚本作用如下图：
![](/files/201707/24205009605_4.png)

- 另外还有一种`项目矩阵授权策略`脚本写法与上述脚本相同，只是将`def strategy = new GlobalMatrixAuthorizationStrategy()`更改为`def strategy = new ProjectMatrixAuthorizationStrategy()`即可
---
layout: post
title: 如何在家用网络中自动更新阿里云DNS解析实现DDNS
category: aliyun,dns,ddns
tags: [__beanhe,aliyun,dns,ddns]
---
    
### 如何在家用网络中自动更新阿里云DNS解析实现DDNS（动态DNS解析）
- 环境准备
	- 家用网络出口有公网IP(某些电信运营商不会为个人用户分配公网IP,比如长城宽带等)
	- 家用路由器支持`DMZ`
	- Python3虚拟环境
	- Python3模块：`alidns`和`docopt`
- 实施步骤
	- 安装所需模块，建议在单独的`virtualenv`（示例中虚拟环境在`/opt/p3`目录）中安装（注意是python3）
		```
		virtualenv /opt/p3
		pip3 install alidns docopt
		```
	- 编写自动更新脚本，脚本内容如下
		```
		#!/bin/bash
		# requirement:
		#   pip3 install alidns docopt
		# Python3 needed
		# Author: Bean He
		# Version: v1

		WELCOME_SCRIPT=/etc/update-motd.d/20-welcome
		ALIDNS=/opt/p3/bin/alidns
		ALI_KEY=<YOUR_ALIYUN_API_KEY>
		ALI_SECRET=<YOUR_ALIYUN_API_SECRET>
		TARGET_DOMAIN=<YOUR_DOMAIN_NAME>
		TARGET_RECORD=<YOUR_TARGET_SUBDOMAIN>
		TARGET_FULL_DNS=$TARGET_RECORD.$TARGET_DOMAIN
		MAIN_CMD="$ALIDNS config $ALI_KEY $ALI_SECRET $TARGET_DOMAIN"

		COUNT=0
		TIMEOUT=3
		while true;do
			TARGET_DNS_IP=`$MAIN_CMD | awk -v dns="$TARGET_FULL_DNS" '{if($2==dns) print $4}'`
			if [ x"$TARGET_DNS_IP" == x"" ] && [ $COUNT -le $TIMEOUT ];then
				TARGET_DNS_IP=`$MAIN_CMD | awk -v dns="$TARGET_FULL_DNS" '{if($2==dns) print $4}'`
				let COUNT+=1
				sleep 1
			else
				break
			fi
		done

		CURRENT_PUBLIC_IP=`curl -s ifconfig.co`
		cat > $WELCOME_SCRIPT <<EOF
		#!/bin/bash
		echo -e "\033[32mServer Public IP: $CURRENT_PUBLIC_IP\033[0m"
		EOF
		chmod +x $WELCOME_SCRIPT

		LOG_PREFIX="DDNS-CronJob[$$]"
		if [ x"$CURRENT_PUBLIC_IP" != x"$TARGET_DNS_IP" ];then
			logger "$LOG_PREFIX IP Changed from $TARGET_DNS_IP to $CURRENT_PUBLIC_IP, updating DNS record $TARGET_FULL_DNS..."
			$ALIDNS remove $TARGET_RECORD
			$ALIDNS add -r $TARGET_RECORD -v $CURRENT_PUBLIC_IP -t A --ttl 600
			logger "$LOG_PREFIX DNS update finished, current DNS record: \"`$MAIN_CMD | awk -v dns="$TARGET_FULL_DNS" '{if($2==dns) print}'`\"."
		else
			logger "$LOG_PREFIX Public IP is the same with current DNS IP: $TARGET_DNS_IP"
		fi
		```
		将脚本中`<>`部分更换成自己的阿里云账号信息和环境信息：
			- `<YOUR_ALIYUN_API_KEY>`：阿里云API的`access key`
			- `<YOUR_ALIYUN_API_SECRET>`:阿里云API的`access secret`
			- `<YOUR_DOMAIN_NAME>`：你的主域名，如`kubiops.com`
			- `<YOUR_TARGET_SUBDOMAIN>`：你需要做自动更新的对象子域名，如值为`sub`代表若脚本发现外网IP发生变化，会自动将解析更新到`sub.kubiops.com`上
	- 通过`cron`定时运行脚本自动更新DNS记录，如将以下内容通过`crontab -e`命令加入到任务列表即可实现每3分钟运行一次脚本
		```
		*/3 * * * * bash <SCRIPT_DIRECTORY>/ddns.sh
		```
		将脚本中`<SCRIPT_DIRECTORY>`替换成你环境中脚本的存放路径
	- 通过家用路由器将内网服务器发布到外网中